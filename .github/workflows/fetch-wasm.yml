name: ðŸ“¥ Fetch WASM Assets

on:
  workflow_call:
    inputs:
      force:
        description: 'Force re-download (ignore cache)'
        required: false
        type: boolean
        default: false
      fetch-yoga:
        description: 'Fetch Yoga Layout WASM'
        required: false
        type: boolean
        default: true
      fetch-models:
        description: 'Fetch AI Models'
        required: false
        type: boolean
        default: true
      fetch-onnx:
        description: 'Fetch ONNX Runtime WASM'
        required: false
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      force:
        description: 'Force re-download (ignore cache)'
        required: false
        type: boolean
        default: false
      fetch-yoga:
        description: 'Fetch Yoga Layout WASM'
        required: false
        type: boolean
        default: true
      fetch-models:
        description: 'Fetch AI Models'
        required: false
        type: boolean
        default: true
      fetch-onnx:
        description: 'Fetch ONNX Runtime WASM'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: fetch-wasm-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  # Socket BTM repository for pre-built assets.
  SOCKET_BTM_REPO: SocketDev/socket-btm

jobs:
  fetch-yoga-layout:
    name: ðŸ§˜ Fetch Yoga Layout WASM
    if: ${{ inputs.fetch-yoga != false }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Get latest yoga-layout release
        id: release
        run: |
          # Find latest yoga-layout release from socket-btm.
          RELEASE_DATA=$(curl -sL "https://api.github.com/repos/${SOCKET_BTM_REPO}/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("yoga-layout-"))] | first')

          if [ "$RELEASE_DATA" = "null" ] || [ -z "$RELEASE_DATA" ]; then
            echo "ERROR: No yoga-layout release found in socket-btm"
            exit 1
          fi

          TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found yoga-layout release: $TAG"

      - name: Restore from cache
        if: inputs.force != true
        id: cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: packages/yoga-layout/build/wasm
          key: yoga-wasm-btm-${{ steps.release.outputs.tag }}
          enableCrossOsArchive: true

      - name: Download yoga-layout assets
        if: steps.cache.outputs.cache-hit != 'true' || inputs.force
        run: |
          TAG="${RELEASE_TAG}"
          echo "Downloading yoga-layout assets from socket-btm release: $TAG"

          mkdir -p packages/yoga-layout/build/wasm

          # Download yoga.wasm.
          curl -sL "https://github.com/${SOCKET_BTM_REPO}/releases/download/${TAG}/yoga-${TAG}.wasm" \
            -o packages/yoga-layout/build/wasm/yoga.wasm

          # Download yoga.mjs (sync version).
          curl -sL "https://github.com/${SOCKET_BTM_REPO}/releases/download/${TAG}/yoga-sync-${TAG}.mjs" \
            -o packages/yoga-layout/build/wasm/yoga.js

          # Verify downloads.
          if [ ! -f "packages/yoga-layout/build/wasm/yoga.wasm" ]; then
            echo "ERROR: Failed to download yoga.wasm"
            exit 1
          fi

          ls -lh packages/yoga-layout/build/wasm/
          echo "yoga.wasm size: $(du -h packages/yoga-layout/build/wasm/yoga.wasm | cut -f1)"
        env:
          RELEASE_TAG: ${{ steps.release.outputs.tag }}

      - name: Upload yoga artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: yoga-wasm
          path: packages/yoga-layout/build/wasm/
          retention-days: 7

  fetch-models:
    name: ðŸ¤– Fetch AI Models
    if: ${{ inputs.fetch-models != false }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Get latest models release
        id: release
        run: |
          # Find latest models release from socket-btm.
          RELEASE_DATA=$(curl -sL "https://api.github.com/repos/${SOCKET_BTM_REPO}/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("models-"))] | first')

          if [ "$RELEASE_DATA" = "null" ] || [ -z "$RELEASE_DATA" ]; then
            echo "ERROR: No models release found in socket-btm"
            exit 1
          fi

          TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found models release: $TAG"

      - name: Restore from cache
        if: inputs.force != true
        id: cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: packages/models/dist
          key: models-btm-${{ steps.release.outputs.tag }}
          enableCrossOsArchive: true

      - name: Download models assets
        if: steps.cache.outputs.cache-hit != 'true' || inputs.force
        run: |
          TAG="${RELEASE_TAG}"
          echo "Downloading models assets from socket-btm release: $TAG"

          mkdir -p packages/models/dist

          # Get list of assets from release.
          ASSETS=$(curl -sL "https://api.github.com/repos/${SOCKET_BTM_REPO}/releases/tags/${TAG}" | \
            jq -r '.assets[].name')

          # Download each .onnx file.
          for asset in $ASSETS; do
            if [[ "$asset" == *.onnx ]]; then
              echo "Downloading $asset..."
              curl -sL "https://github.com/${SOCKET_BTM_REPO}/releases/download/${TAG}/${asset}" \
                -o "packages/models/dist/${asset}"
            fi
          done

          ls -lh packages/models/dist/
        env:
          RELEASE_TAG: ${{ steps.release.outputs.tag }}

      - name: Verify model artifacts
        run: |
          echo "=== AI Models Artifacts ==="
          # Check for at least one model file.
          if ! ls packages/models/dist/*.onnx 1>/dev/null 2>&1; then
            echo "ERROR: No ONNX model files found!"
            exit 1
          fi
          ls -lh packages/models/dist/

      - name: Upload models artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ai-models
          path: packages/models/dist/
          retention-days: 7

  fetch-onnx-runtime:
    name: ðŸŒ Fetch ONNX Runtime WASM
    if: ${{ inputs.fetch-onnx != false }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Get latest onnxruntime release
        id: release
        run: |
          # Find latest onnxruntime release from socket-btm.
          RELEASE_DATA=$(curl -sL "https://api.github.com/repos/${SOCKET_BTM_REPO}/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("onnxruntime-"))] | first')

          if [ "$RELEASE_DATA" = "null" ] || [ -z "$RELEASE_DATA" ]; then
            echo "ERROR: No onnxruntime release found in socket-btm"
            exit 1
          fi

          TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Found onnxruntime release: $TAG"

      - name: Restore from cache
        if: inputs.force != true
        id: cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: packages/onnxruntime/build/wasm
          key: onnx-runtime-btm-${{ steps.release.outputs.tag }}
          enableCrossOsArchive: true

      - name: Download onnxruntime assets
        if: steps.cache.outputs.cache-hit != 'true' || inputs.force
        run: |
          TAG="${RELEASE_TAG}"
          echo "Downloading onnxruntime assets from socket-btm release: $TAG"

          mkdir -p packages/onnxruntime/build/wasm

          # Get list of assets from release.
          ASSETS=$(curl -sL "https://api.github.com/repos/${SOCKET_BTM_REPO}/releases/tags/${TAG}" | \
            jq -r '.assets[].name')

          # Download WASM and JS files.
          for asset in $ASSETS; do
            if [[ "$asset" == *.wasm ]] || [[ "$asset" == *.mjs ]] || [[ "$asset" == *.js ]]; then
              echo "Downloading $asset..."
              curl -sL "https://github.com/${SOCKET_BTM_REPO}/releases/download/${TAG}/${asset}" \
                -o "packages/onnxruntime/build/wasm/${asset}"
            fi
          done

          ls -lh packages/onnxruntime/build/wasm/
        env:
          RELEASE_TAG: ${{ steps.release.outputs.tag }}

      - name: Verify onnxruntime artifacts
        run: |
          echo "=== ONNX Runtime Artifacts ==="
          # Check for WASM file.
          if ! ls packages/onnxruntime/build/wasm/*.wasm 1>/dev/null 2>&1; then
            echo "ERROR: No ONNX Runtime WASM files found!"
            exit 1
          fi
          ls -lh packages/onnxruntime/build/wasm/

      - name: Upload onnxruntime artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: onnx-runtime
          path: packages/onnxruntime/build/wasm/
          retention-days: 7

  summary:
    name: ðŸ“Š Fetch Summary
    if: always() && !cancelled()
    needs: [fetch-yoga-layout, fetch-models, fetch-onnx-runtime]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        continue-on-error: true
        with:
          path: artifacts

      - name: Generate summary
        run: |
          echo "# ðŸ“¥ WASM Assets Fetch Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Assets downloaded from [socket-btm](https://github.com/${SOCKET_BTM_REPO}) releases." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check status of fetches.
          YOGA_STATUS="${NEEDS_FETCH_YOGA_LAYOUT_RESULT}"
          MODELS_STATUS="${NEEDS_FETCH_MODELS_RESULT}"
          ONNX_STATUS="${NEEDS_FETCH_ONNX_RUNTIME_RESULT}"

          # Determine overall status.
          if [ "$YOGA_STATUS" = "failure" ] || [ "$MODELS_STATUS" = "failure" ] || [ "$ONNX_STATUS" = "failure" ]; then
            echo "## âœ— Fetch Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more downloads failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          elif [ "$YOGA_STATUS" = "skipped" ] && [ "$MODELS_STATUS" = "skipped" ] && [ "$ONNX_STATUS" = "skipped" ]; then
            echo "## âŠ˜ Fetches Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All fetches were skipped (likely due to workflow inputs)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ“ Fetch Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "WASM assets downloaded successfully from socket-btm." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Asset | Status | Source |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Yoga Layout.
          if [ "$YOGA_STATUS" = "success" ]; then
            echo "| ðŸ§˜ Yoga Layout | âœ“ | socket-btm |" >> $GITHUB_STEP_SUMMARY
          elif [ "$YOGA_STATUS" = "skipped" ]; then
            echo "| ðŸ§˜ Yoga Layout | âŠ˜ | Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§˜ Yoga Layout | âœ— | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # AI Models.
          if [ "$MODELS_STATUS" = "success" ]; then
            echo "| ðŸ¤– AI Models | âœ“ | socket-btm |" >> $GITHUB_STEP_SUMMARY
          elif [ "$MODELS_STATUS" = "skipped" ]; then
            echo "| ðŸ¤– AI Models | âŠ˜ | Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ¤– AI Models | âœ— | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # ONNX Runtime.
          if [ "$ONNX_STATUS" = "success" ]; then
            echo "| ðŸŒ ONNX Runtime | âœ“ | socket-btm |" >> $GITHUB_STEP_SUMMARY
          elif [ "$ONNX_STATUS" = "skipped" ]; then
            echo "| ðŸŒ ONNX Runtime | âŠ˜ | Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŒ ONNX Runtime | âœ— | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download time: ~5-10 minutes (vs 2-3 hours building from source)" >> $GITHUB_STEP_SUMMARY

        env:
          NEEDS_FETCH_YOGA_LAYOUT_RESULT: ${{ needs.fetch-yoga-layout.result }}
          NEEDS_FETCH_MODELS_RESULT: ${{ needs.fetch-models.result }}
          NEEDS_FETCH_ONNX_RUNTIME_RESULT: ${{ needs.fetch-onnx-runtime.result }}
