import { getErrorCause } from './error/errors.mjs'
import { cacheFetch, getOctokit } from './git/github.mjs'

import type { CResult } from '../types.mjs'

/**
 * Converts CVE IDs to GHSA IDs using GitHub API.
 * CVE to GHSA mappings are permanent, so we cache for 30 days.
 */
export async function convertCveToGhsa(
  cveId: string,
): Promise<CResult<string>> {
  try {
    const cacheKey = `cve-to-ghsa-${cveId}`
    const octokit = getOctokit()

    // CVE to GHSA mappings don't change, cache for 30 days (in milliseconds).
    const THIRTY_DAYS_MS = 2_592_000_000

    const response = await cacheFetch(
      cacheKey,
      () =>
        octokit.rest.securityAdvisories.listGlobalAdvisories({
          cve_id: cveId,
          per_page: 1,
        }),
      THIRTY_DAYS_MS,
    )

    if (!response.data.length) {
      return {
        ok: false,
        message: `No GHSA found for CVE ${cveId}`,
      }
    }

    const ghsaId = response.data[0]?.ghsa_id
    if (!ghsaId) {
      return {
        ok: false,
        message: `No GHSA ID found in response for CVE ${cveId}`,
      }
    }

    return {
      ok: true,
      data: ghsaId,
    }
  } catch (e) {
    const errorCause = getErrorCause(e)
    // Detect GitHub API rate limit errors.
    const isGitHubRateLimit =
      errorCause.includes('rate limit') ||
      errorCause.includes('EPIPE') ||
      errorCause.includes('ECONNRESET') ||
      errorCause.includes('403')

    return {
      ok: false,
      message: isGitHubRateLimit
        ? 'GitHub API rate limit exceeded while converting CVE to GHSA. Wait an hour or set SOCKET_CLI_GITHUB_TOKEN environment variable with a personal access token for higher limits.'
        : `Failed to convert CVE to GHSA: ${errorCause}`,
    }
  }
}
