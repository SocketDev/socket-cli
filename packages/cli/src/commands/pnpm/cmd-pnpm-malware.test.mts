import { describe, expect } from 'vitest'

import { cmdit, spawnSocketCli } from '../../../test/utils.mts'
import { FLAG_CONFIG, FLAG_DRY_RUN } from '../constants/cli.mts'
import { getBinCliPath } from '../constants/paths.mts'

const binCliPath = getBinCliPath()

describe('socket pnpm - malware detection with mocked packages', () => {
  describe('pnpm exec with issueRules configuration', () => {
    cmdit(
      [
        'pnpm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true}}',
      ],
      'should handle pnpm exec with -c flag and malware issueRule for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(code, 'dry-run pnpm exec with -c should exit with code 0').toBe(
          0,
        )
      },
    )

    cmdit(
      [
        'pnpm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"gptMalware":true}}',
      ],
      'should handle pnpm exec with -c flag and gptMalware issueRule for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(code, 'dry-run pnpm exec with -c should exit with code 0').toBe(
          0,
        )
      },
    )

    cmdit(
      [
        'pnpm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle pnpm exec with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(
          code,
          'dry-run pnpm exec with multiple issueRules should exit with code 0',
        ).toBe(0)
      },
    )

    cmdit(
      [
        'pnpm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        FLAG_CONFIG,
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle pnpm exec with --config flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(
          code,
          'dry-run pnpm exec with --config should exit with code 0',
        ).toBe(0)
      },
    )
  })

  describe('pnpm install with issueRules configuration', () => {
    cmdit(
      [
        'pnpm',
        'install',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle pnpm install with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(
          code,
          'dry-run pnpm install with -c should exit with code 0',
        ).toBe(0)
      },
    )

    cmdit(
      [
        'pnpm',
        'add',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle pnpm add with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(code, 'dry-run pnpm add with -c should exit with code 0').toBe(0)
      },
    )

    cmdit(
      [
        'pnpm',
        'install',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        FLAG_CONFIG,
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle pnpm install with --config flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)
        expect(stdout).toMatchInlineSnapshot(`""`)
        expect(
          code,
          'dry-run pnpm install with --config should exit with code 0',
        ).toBe(0)
      },
    )
  })
})
