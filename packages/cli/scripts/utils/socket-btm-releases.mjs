/**
 * Shared utilities for socket-cli build scripts that extract socket-btm assets.
 * Contains socket-cli-specific utilities for header generation and file hashing.
 */

import { createHash } from 'node:crypto'
import { readFile } from 'node:fs/promises'

import { fetchGitHub } from '@socketsecurity/lib/github'

/**
 * Find the latest asset in a socket-btm release that matches a prefix and suffix.
 *
 * @param {string} tool - Tool name (e.g., 'yoga-layout', 'models')
 * @param {string} prefix - Asset name prefix (e.g., 'yoga-sync-', 'models-')
 * @param {string} suffix - Asset name suffix (e.g., '.mjs', '.tar.gz')
 * @returns {Promise<string>} - Asset name
 */
export async function findAsset(tool, prefix, suffix) {
  // Get all releases using fetchGitHub from @socketsecurity/lib.
  const releases = await fetchGitHub(
    'https://api.github.com/repos/SocketDev/socket-btm/releases?per_page=100',
  )

  // Find the latest release for this tool (tag starts with tool name).
  const release = releases.find((r) => r.tag_name.startsWith(`${tool}-`))
  if (!release) {
    throw new Error(`No release found for tool: ${tool}`)
  }

  // Find the asset matching the prefix and suffix.
  const asset = release.assets.find(
    (a) => a.name.startsWith(prefix) && a.name.endsWith(suffix),
  )
  if (!asset) {
    throw new Error(
      `No asset found matching ${prefix}*${suffix} in release ${release.tag_name}`,
    )
  }

  return asset.name
}

/**
 * Compute SHA256 hash of file content.
 *
 * @param {string} filePath - Path to file
 * @returns {Promise<string>} - Hex-encoded SHA256 hash
 */
export async function computeFileHash(filePath) {
  const content = await readFile(filePath)
  return createHash('sha256').update(content).digest('hex')
}

/**
 * Generate file header with metadata.
 *
 * @param {object} options - Header options
 * @param {string} options.scriptName - Name of generating script
 * @param {string} options.tag - Release tag
 * @param {string} options.assetName - Asset filename
 * @param {string} [options.sourceHash] - Optional source hash
 * @returns {string} - File header comment
 */
export function generateHeader({ assetName, scriptName, sourceHash, tag }) {
  const hashLine = sourceHash ? `\n * Source hash: ${sourceHash}` : ''

  return `/**
 * AUTO-GENERATED by ${scriptName}
 * DO NOT EDIT MANUALLY - changes will be overwritten on next build.
 *
 * Source: socket-btm GitHub releases (${tag})
 * Asset: ${assetName}${hashLine}
 */`
}
