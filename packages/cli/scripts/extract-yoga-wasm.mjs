/**
 * Download yoga-sync.js from socket-btm GitHub releases.
 * This is a pre-built synchronous yoga-layout with embedded WASM binary.
 *
 * Source: https://github.com/SocketDev/socket-btm/releases
 * Fallback: Generates placeholder stub if release is not available.
 *
 * Idempotent: Skips regeneration if cached file hasn't changed.
 */

import { readFileSync, writeFileSync } from 'node:fs'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

import { getDefaultLogger } from '@socketsecurity/lib/logger'

import {
  computeFileHash,
  downloadAsset,
  findAsset,
  generateHeader,
  getCacheDir,
  getLatestRelease,
  needsExtraction,
} from './utils/socket-btm-releases.mjs'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const rootPath = path.join(__dirname, '..')
const logger = getDefaultLogger()

const outputPath = path.join(rootPath, 'build/yoga-sync.mjs')
const cacheDir = getCacheDir('yoga', rootPath)

/**
 * Generate placeholder stub when yoga WASM is not available.
 */
function generatePlaceholderStub() {
  const placeholderContent = `/**
 * Synchronous yoga-layout with embedded WASM binary (Placeholder).
 *
 * This file is AUTO-GENERATED by scripts/extract-yoga-wasm.mjs
 * DO NOT EDIT MANUALLY - changes will be overwritten on next build.
 *
 * NOTE: This is a placeholder stub. The actual WASM is from socket-btm releases.
 * Source: https://github.com/SocketDev/socket-btm/releases
 */

// Placeholder yoga export with minimal API.
const yoga = {
  Config: class Config {},
  Node: class Node {
    static create() {
      return new Node()
    }
    calculateLayout() {}
    getComputedLayout() {
      return { left: 0, top: 0, width: 0, height: 0 }
    }
  },
}

export default yoga
`

  writeFileSync(outputPath, placeholderContent, 'utf-8')
  logger.warn('Using placeholder yoga (affects table rendering)')
  process.exit(0)
}

/**
 * Main extraction logic.
 */
async function main() {
  try {
    logger.group('Extracting yoga-layout from socket-btm releases...')

    // Fetch latest yoga-layout release.
    const release = await getLatestRelease(
      'yoga-layout-',
      'SOCKET_BTM_YOGA_TAG',
    )
    if (!release) {
      logger.groupEnd()
      generatePlaceholderStub()
      return
    }

    const { release: releaseData, tag } = release

    // Find yoga-sync.mjs asset (ES module version).
    const assetName = findAsset(
      releaseData,
      a => a.name.startsWith('yoga-sync') && a.name.endsWith('.mjs'),
    )
    if (!assetName) {
      logger.groupEnd()
      generatePlaceholderStub()
      return
    }

    // Download asset with caching.
    const cachedPath = await downloadAsset({ assetName, cacheDir, tag })

    // Check if extraction needed.
    const extractNeeded = await needsExtraction(
      cachedPath,
      outputPath,
      content =>
        content.includes('yoga-layout') && content.includes('export default'),
    )

    if (!extractNeeded) {
      logger.info('yoga-layout already up to date')
      logger.groupEnd()
      logger.log('')
      logger.success('yoga-layout extraction complete')
      process.exit(0)
    }

    // Read the downloaded yoga-sync.js file.
    const syncContent = readFileSync(cachedPath, 'utf-8')

    // Compute source hash for cache validation.
    const sourceHash = await computeFileHash(cachedPath)

    // Generate output file with header.
    const header = generateHeader({
      assetName,
      scriptName: 'scripts/extract-yoga-wasm.mjs',
      sourceHash,
      tag,
    })

    // The .mjs file from socket-btm should already have proper ES module exports.
    // Just add our header and use the content as-is.
    const jsContent = `${header}

${syncContent}
`

    writeFileSync(outputPath, jsContent, 'utf-8')
    logger.groupEnd()
    logger.log('')
    logger.success('yoga-layout extraction complete')
  } catch (e) {
    logger.groupEnd()
    logger.error(`Unexpected error: ${e.message}`)
    generatePlaceholderStub()
  }
}

main()
