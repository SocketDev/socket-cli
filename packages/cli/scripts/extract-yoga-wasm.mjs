/**
 * Download yoga-sync.js from socket-btm GitHub releases.
 * This is a pre-built synchronous yoga-layout with embedded WASM binary.
 *
 * Source: https://github.com/SocketDev/socket-btm/releases
 * Fallback: Generates placeholder stub if release is not available.
 *
 * Idempotent: Skips regeneration if cached file hasn't changed.
 */

import { existsSync } from 'node:fs'
import { readFile, writeFile } from 'node:fs/promises'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

import { getDefaultLogger } from '@socketsecurity/lib/logger'
import { downloadSocketBtmRelease } from '@socketsecurity/lib/releases/socket-btm'

import { computeFileHash, generateHeader } from './utils/socket-btm-releases.mjs'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const rootPath = path.join(__dirname, '..')
const logger = getDefaultLogger()

const outputPath = path.join(rootPath, 'build/yoga-sync.mjs')
const versionPath = path.join(rootPath, 'build/yoga.version')

/**
 * Generate placeholder stub when yoga WASM is not available.
 */
async function generatePlaceholderStub() {
  const placeholderContent = `/**
 * Synchronous yoga-layout with embedded WASM binary (Placeholder).
 *
 * This file is AUTO-GENERATED by scripts/extract-yoga-wasm.mjs
 * DO NOT EDIT MANUALLY - changes will be overwritten on next build.
 *
 * NOTE: This is a placeholder stub. The actual WASM is from socket-btm releases.
 * Source: https://github.com/SocketDev/socket-btm/releases
 */

// Placeholder yoga export with minimal API.
const yoga = {
  Config: class Config {},
  Node: class Node {
    static create() {
      return new Node()
    }
    calculateLayout() {}
    getComputedLayout() {
      return { left: 0, top: 0, width: 0, height: 0 }
    }
  },
}

export default yoga
`

  await writeFile(outputPath, placeholderContent, 'utf-8')
  logger.warn('Using placeholder yoga (affects table rendering)')
  process.exit(0)
}

/**
 * Main extraction logic.
 */
async function main() {
  try {
    logger.group('Extracting yoga-layout from socket-btm releases...')

    let assetPath
    try {
      // Download yoga-sync.mjs asset using @socketsecurity/lib helper.
      // This handles version caching automatically.
      // Asset name pattern: yoga-sync-{DATE}-{COMMIT}.mjs
      assetPath = await downloadSocketBtmRelease({
        asset: 'yoga-sync-20260106-a39285c.mjs',
        cwd: rootPath,
        downloadDir: '../../build-infra/build/downloaded',
        envVar: 'SOCKET_BTM_YOGA_TAG',
        quiet: false,
        tool: 'yoga-layout',
      })
    } catch (e) {
      logger.groupEnd()
      logger.warn(`yoga-layout not available: ${e.message}`)
      await generatePlaceholderStub()
      return
    }

    // Check if extraction needed by comparing version.
    // Read the version from the downloaded file's directory.
    const assetDir = path.dirname(assetPath)
    const sourceVersionPath = path.join(assetDir, '.version')

    if (existsSync(versionPath) && existsSync(outputPath) && existsSync(sourceVersionPath)) {
      const cachedVersion = (await readFile(versionPath, 'utf8')).trim()
      const sourceVersion = (await readFile(sourceVersionPath, 'utf8')).trim()
      if (cachedVersion === sourceVersion) {
        logger.info('yoga-layout already up to date')
        logger.groupEnd()
        logger.success('yoga-layout extraction complete')
        process.exit(0)
      }
    }

    // Read the downloaded yoga-sync.js file.
    const syncContent = await readFile(assetPath, 'utf-8')

    // Compute source hash for cache validation.
    const sourceHash = await computeFileHash(assetPath)

    // Get tag from source version file.
    const tag = existsSync(sourceVersionPath)
      ? (await readFile(sourceVersionPath, 'utf8')).trim()
      : 'unknown'

    // Generate output file with header.
    const header = generateHeader({
      assetName: path.basename(assetPath),
      scriptName: 'scripts/extract-yoga-wasm.mjs',
      sourceHash,
      tag,
    })

    // The .mjs file from socket-btm should already have proper ES module exports.
    // Just add our header and use the content as-is.
    const jsContent = `${header}

${syncContent}
`

    await writeFile(outputPath, jsContent, 'utf-8')

    // Write version file.
    await writeFile(versionPath, tag, 'utf-8')

    logger.groupEnd()
    logger.success('yoga-layout extraction complete')
  } catch (e) {
    logger.groupEnd()
    logger.error(`Unexpected error: ${e.message}`)
    await generatePlaceholderStub()
  }
}

main()
