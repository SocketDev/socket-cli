/**
 * Integration tests for `socket npm` malware detection.
 *
 * Tests malware scanning in npm wrapper operations. These tests verify
 * that Socket detects and blocks known malicious packages before execution.
 *
 * Test Coverage:
 * - Malware detection in npm install
 * - Known malicious package blocking
 * - User warnings for suspicious packages
 * - Exit codes for malware detection
 *
 * Security Features:
 * - Pre-installation malware scanning
 * - GPT-based malware detection (issueRules.gptMalware)
 * - Signature-based malware detection (issueRules.malware)
 *
 * Related Files:
 * - src/commands/wrapper/npm.mts - npm wrapper with security scanning
 * - src/shadow/npm/ - Shadow npm implementation
 * - test/integration/cli/cmd-npm.test.mts - General npm wrapper tests
 */

import { describe, expect } from 'vitest'

import { FLAG_CONFIG, FLAG_DRY_RUN } from '../../../src/constants/cli.mts'
import { getBinCliPath } from '../../../src/constants/paths.mts'
import { expectDryRunOutput } from '../../helpers/output-assertions.mts'
import { cmdit, spawnSocketCli } from '../../utils.mts'

const binCliPath = getBinCliPath()

describe('socket npm - malware detection with mocked packages', () => {
  describe('npm exec with issueRules configuration', () => {
    cmdit(
      [
        'npm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true}}',
      ],
      'should handle exec with -c flag and malware issueRule for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(code, 'dry-run exec with -c should exit with code 0').toBe(0)
      },
    )

    cmdit(
      [
        'npm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"gptMalware":true}}',
      ],
      'should handle exec with -c flag and gptMalware issueRule for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(code, 'dry-run exec with -c should exit with code 0').toBe(0)
      },
    )

    cmdit(
      [
        'npm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle exec with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(
          code,
          'dry-run exec with multiple issueRules should exit with code 0',
        ).toBe(0)
      },
    )

    cmdit(
      [
        'npm',
        'exec',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        FLAG_CONFIG,
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle exec with --config flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(code, 'dry-run exec with --config should exit with code 0').toBe(
          0,
        )
      },
    )
  })

  describe('npm install with issueRules configuration', () => {
    cmdit(
      [
        'npm',
        'install',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle install with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(code, 'dry-run install with -c should exit with code 0').toBe(0)
      },
    )

    cmdit(
      [
        'npm',
        'i',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        '-c',
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle i alias with -c flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(code, 'dry-run i with -c should exit with code 0').toBe(0)
      },
    )

    cmdit(
      [
        'npm',
        'install',
        'evil-test-package@1.0.0',
        FLAG_DRY_RUN,
        FLAG_CONFIG,
        '{"apiToken":"fakeToken","issueRules":{"malware":true,"gptMalware":true}}',
      ],
      'should handle install with --config flag and multiple issueRules for evil-test-package',
      async cmd => {
        const { code, stdout } = await spawnSocketCli(binCliPath, cmd)

        // Validate dry-run output to prevent flipped snapshots.
        expectDryRunOutput(stdout)
        expect(stdout).toMatchInlineSnapshot(`"[DryRun]: Bailing now"`)
        expect(
          code,
          'dry-run install with --config should exit with code 0',
        ).toBe(0)
      },
    )
  })
})
