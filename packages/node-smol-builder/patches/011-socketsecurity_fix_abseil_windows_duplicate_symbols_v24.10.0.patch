# @node-versions: v24.10.0+
# @description: Fix abseil duplicate symbol errors on Windows
#
# Disables standalone abseil.lib build on Windows by changing the abseil
# target type from 'static_library' to 'none'. This prevents LNK2005
# linker errors where absl::Mutex::Dtor and other symbols are defined
# in both abseil.lib and v8_libbase.lib.
#
# Root cause: Node.js v24 extracted abseil to a separate build target
# (tools/v8_gypfiles/abseil.gyp) to share code between V8 and perfetto.
# On Windows with MSVC, this creates duplicate symbol errors because
# V8's libbase already includes the necessary abseil implementations.
#
# Solution: On Windows only, configure abseil as type 'none' so headers
# are available but no separate static library is built. V8's libbase
# continues to provide the abseil implementations it needs.
#
# Error: abseil.lib(abseil.mutex.obj) : error LNK2005: absl::Mutex::Dtor
# already defined in v8_libbase.lib(v8_libbase.mutex.obj)
#
# References:
# - https://github.com/nodejs/node/pull/57289 (abseil extraction)
# - https://github.com/nodejs/node/pull/57582 (abseil deadlock detection)

--- a/tools/v8_gypfiles/abseil.gyp
+++ b/tools/v8_gypfiles/abseil.gyp
@@ -3,7 +3,15 @@
   'targets': [
     {
       'target_name': 'abseil',
-      'type': 'static_library',
+      'conditions': [
+        ['OS=="win"', {
+          # On Windows, abseil symbols are already included in v8_libbase.
+          # Building a separate abseil.lib causes LNK2005 duplicate symbol errors.
+          'type': 'none',
+        }, {
+          'type': 'static_library',
+        }],
+      ],
       'toolsets': ['host', 'target'],
       'variables': {
         'ABSEIL_ROOT': '../../deps/v8/third_party/abseil-cpp',
