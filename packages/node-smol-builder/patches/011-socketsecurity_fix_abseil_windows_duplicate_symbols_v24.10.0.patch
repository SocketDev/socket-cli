# @node-versions: v24.10.0+
# @description: Fix abseil duplicate symbol errors on Windows
#
# Adds /FORCE:MULTIPLE linker flag globally for Windows builds to allow
# duplicate symbol definitions between abseil.lib and v8_libbase.lib.
#
# Root cause: Node.js v24 extracted abseil to a separate build target
# (tools/v8_gypfiles/abseil.gyp) to share code between V8 and perfetto.
# v8_libbase depends on and links against abseil.lib, but some abseil
# symbols end up defined in both libraries, causing LNK2005 errors when
# linking executables that use both (like torque.exe).
#
# Solution: Add /FORCE:MULTIPLE to all Windows link operations via the
# toolchain configuration. The linker will pick one definition of each
# duplicate symbol. This is safe because the implementations are identical.
#
# Original errors:
# LNK2005: absl::Mutex::Dtor already defined in v8_libbase.lib
# LNK1169: one or more multiply defined symbols found
#
# References:
# - https://github.com/nodejs/node/pull/57289 (abseil extraction)
# - https://learn.microsoft.com/en-us/cpp/build/reference/force-force-file-output

--- a/tools/v8_gypfiles/toolchain.gypi
+++ b/tools/v8_gypfiles/toolchain.gypi
@@ -525,6 +525,11 @@
               '/bigobj', # Prevent C1128: number of sections exceeded object file format limit.
             ],
           },
+          'VCLinkerTool': {
+            'AdditionalOptions': [
+              '/FORCE:MULTIPLE', # Allow duplicate symbol definitions (abseil.lib vs v8_libbase.lib).
+            ],
+          },
         },
       }],
       ['v8_target_arch=="ia32"', {
