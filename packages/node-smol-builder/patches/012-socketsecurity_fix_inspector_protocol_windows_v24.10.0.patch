# @node-versions: v24.10.0+
# @description: Fix inspector protocol code generator on Windows
#
# On Windows, the --config_value argument passing through gyp-win-tool and
# ninja response files fails to properly set config.protocol.path, causing:
# AttributeError: 'X' object has no attribute 'path'
#
# This patch modifies code_generator.py to accept the config file path and
# compute the protocol path from it when --config_value fails to set it.
#
# Root cause: When ninja executes the action through gyp-win-tool action-wrapper
# on Windows, arguments in response files (.rsp) don't preserve the
# --config_value protocol.path=... argument correctly, so the path attribute
# never gets added to the protocol config object by init_defaults().
#
# Solution:
# 1. Compute protocol path in main() before creating Protocol object
# 2. Add path to config.protocol namedtuple using _replace()
# 3. Pass updated config to Protocol.__init__()
# 4. Use protocol.config.protocol.path in main() for inputs
#
# Original error:
# AttributeError: 'X' object has no attribute 'path'
# At: code_generator.py:365 in Protocol.__init__() and line 635 in main()
#
# References:
# - Node.js v24 gyp build system Windows argument passing
# - tools/v8_gypfiles/v8.gyp protocol_generated_sources action

diff --git a/deps/v8/third_party/inspector_protocol/code_generator.py b/deps/v8/third_party/inspector_protocol/code_generator.py
index b1bedb58..c702516a 100755
--- a/deps/v8/third_party/inspector_protocol/code_generator.py
+++ b/deps/v8/third_party/inspector_protocol/code_generator.py
@@ -604,8 +604,20 @@ class Protocol(object):
 def main():
   jinja_dir, config_file, config = read_config()

-  protocol = Protocol(config)
+  # Windows gyp-win-tool may fail to pass --config_value correctly.
+  # Fall back to computing the path from the config file location.
+  if not hasattr(config.protocol, 'path'):
+    # Compute path from config file: deps/v8/src/inspector -> deps/v8/include
+    if config_file:
+      config_dir = os.path.dirname(config_file)
+      protocol_path = os.path.normpath(os.path.join(config_dir, '../../include/js_protocol.pdl'))
+      # Add path to config.protocol so Protocol.__init__() and later code can use it
+      protocol_obj = config.protocol._replace(path=protocol_path) if hasattr(config.protocol, '_replace') else config.protocol
+      config = config._replace(protocol=protocol_obj) if hasattr(config, '_replace') else config
+    else:
+      raise Exception("config.protocol.path not set and config_file not provided")

+  protocol = Protocol(config)
+
   if not config.exported and len(protocol.exported_domains):
     sys.stderr.write(("Domains [%s] are exported, but config is missing export "
