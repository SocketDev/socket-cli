# @node-versions: v24.10.0+
# @description: Fix inspector protocol code generator on Windows
#
# On Windows, the --config_value argument passing through gyp-win-tool and
# ninja response files fails to properly set config.protocol.path, causing:
# AttributeError: 'X' object has no attribute 'path'
#
# This patch modifies code_generator.py to accept the config file path and
# compute the protocol path from it when --config_value fails to set it.
#
# Root cause: When ninja executes the action through gyp-win-tool action-wrapper
# on Windows, arguments in response files (.rsp) don't preserve the
# --config_value protocol.path=... argument correctly, so the path attribute
# never gets added to the protocol config object by init_defaults().
#
# Solution:
# 1. Modify Protocol.__init__() to accept config_file parameter
# 2. Compute protocol path from config file location when missing
# 3. Add the path to config.protocol so main() can use it
#
# Original error:
# AttributeError: 'X' object has no attribute 'path'
# At: code_generator.py:365 in Protocol.__init__
#
# References:
# - Node.js v24 gyp build system Windows argument passing
# - tools/v8_gypfiles/v8.gyp protocol_generated_sources action

--- a/deps/v8/third_party/inspector_protocol/code_generator.py
+++ b/deps/v8/third_party/inspector_protocol/code_generator.py
@@ -357,12 +357,27 @@
 
 class Protocol(object):
 
-  def __init__(self, config):
+  def __init__(self, config, config_file=None):
     self.config = config
     self.json_api = {"domains": []}
     self.imported_domains = []
     self.exported_domains = []
-    self.generate_domains = self.read_protocol_file(config.protocol.path)
+    # Windows gyp-win-tool may fail to pass --config_value correctly.
+    # Fall back to computing the path from the config file location.
+    if hasattr(config.protocol, 'path'):
+      protocol_path = config.protocol.path
+    else:
+      # Compute path from config file: deps/v8/src/inspector -> deps/v8/include
+      if config_file:
+        config_dir = os.path.dirname(config_file)
+        protocol_path = os.path.normpath(os.path.join(config_dir, '../../include/js_protocol.pdl'))
+      else:
+        raise Exception("config.protocol.path not set and config_file not provided")
+      # Add path to config so main() can use it later.
+      protocol_obj = config.protocol._replace(path=protocol_path)
+      config = config._replace(protocol=protocol_obj)
+      self.config = config
+    self.generate_domains = self.read_protocol_file(protocol_path)
 
     if config.protocol.options:
       self.generate_domains = [rule.domain for rule in config.protocol.options]
@@ -604,7 +619,7 @@
 def main():
   jinja_dir, config_file, config = read_config()
 
-  protocol = Protocol(config)
+  protocol = Protocol(config, config_file)
 
   if not config.exported and len(protocol.exported_domains):
     sys.stderr.write(("Domains [%s] are exported, but config is missing export "
