# @node-versions: v24.10.0+
# @description: Load Socket security bootstrap using vm.compileFunction() C++ API
#
# This approach uses the modern C++ API for optimal performance:
# 1. vm.compileFunction() directly compiles code with module context parameters
# 2. Single C++ call (no wrapping + compilation steps)
# 3. Async code can run in the background while Node.js continues initialization
#
# The bootstrap code is embedded as base64 and decoded at runtime (no filesystem dependency).

--- a/lib/internal/process/pre_execution.js
+++ b/lib/internal/process/pre_execution.js
@@ -673,6 +673,46 @@ function runEmbedderPreload() {
   internalBinding('mksnapshot').runEmbedderPreload(process, require);
 }

 function loadPreloadModules() {
+  // Load Socket security bootstrap using vm.compileFunction() C++ API.
+  // This allows async code in the bootstrap (unlike direct require()).
+  (function loadSocketBootstrap() {
+    // Bootstrap code embedded as base64 (build system replaces this placeholder).
+    // Split across multiple lines to avoid git patch line length limits.
+    const SOCKET_BOOTSTRAP_B64 = (
+      SOCKET_BOOTSTRAP_BASE64_PLACEHOLDER
+    );
+
+    try {
+      const Module = require('internal/modules/cjs/loader').Module;
+      const { makeRequireFunction } = require('internal/modules/helpers');
+      const vm = require('vm');
+      const { Buffer } = require('buffer');
+
+      // Decode bootstrap from base64.
+      const bootstrapCode = Buffer.from(SOCKET_BOOTSTRAP_B64, 'base64').toString('utf8');
+
+      // Create module context.
+      const bootstrapModule = new Module('socket:bootstrap', null);
+      bootstrapModule.filename = 'socket:bootstrap';
+      bootstrapModule.paths = Module._nodeModulePaths(process.cwd());
+      const exports = {};
+      bootstrapModule.exports = exports;
+
+      // Create require using Node.js internal helper (adds resolve, cache, etc).
+      const moduleRequire = makeRequireFunction(bootstrapModule);
+
+      // Compile using C++ API with module parameters.
+      const compiledFn = vm.compileFunction(bootstrapCode, ['exports', 'require', 'module', '__filename', '__dirname'], {
+        filename: 'socket:bootstrap',
+        lineOffset: 0,
+        columnOffset: 0,
+      });
+
+      // Execute with module context.
+      // If bootstrap contains async code (main().catch(...)), it starts executing
+      // but returns immediately - async operations run in background.
+      compiledFn.call(exports, exports, moduleRequire, bootstrapModule, 'socket:bootstrap', '');
+    } catch (err) {
+      // Use stderr.write to avoid console dependencies during early bootstrap.
+      process.stderr.write(`Socket bootstrap error: ${err.message}\n${err.stack}\n`);
+    }
+  })();
+
  // For user code, we preload modules if `-r` is passed
  const preloadModules = getOptionValue('--require');
  if (preloadModules && preloadModules.length > 0) {
