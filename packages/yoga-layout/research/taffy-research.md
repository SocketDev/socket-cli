# Yoga Layout WASM

**⚠️ STATUS: Research & Prototyping - Using Official Yoga C++ with Emscripten**

This package builds Yoga Layout from the official C++ implementation using Emscripten, optimized for Socket CLI's terminal rendering needs.

## Previous Research: Taffy-based Implementation

We explored building a pure Rust implementation using [Taffy](https://github.com/DioxusLabs/taffy) to avoid C++ toolchain dependencies. While promising, we discovered critical blockers:

- **Measure functions**: Required by Ink for text measurement, not supported by Taffy
- **Border layout**: Ink uses borders extensively, Taffy v0.6 doesn't include border in layout calculations

**Decision**: Use official Yoga C++ with Emscripten for 100% compatibility with Ink and other Yoga consumers.

**Research artifacts preserved**: See [TAFFY-RESEARCH.md](./TAFFY-RESEARCH.md) for the Taffy exploration, architecture, and compatibility analysis.

## Table of Contents

- [Why This Exists](#why-this-exists)
- [Architecture](#architecture)
- [Installation](#installation)
- [Usage](#usage)
- [API Compatibility](#api-compatibility)
- [Build System](#build-system)
- [Testing](#testing)
- [Performance](#performance)
- [Limitations](#limitations)
- [References](#references)

## Why This Exists

### Problem

The original Yoga Layout requires:
- C++ toolchain (clang++)
- Emscripten SDK for WASM compilation
- Complex build dependencies
- Platform-specific binaries

This creates friction for:
- CI/CD environments
- Cross-platform development
- Dependency management
- Build reproducibility

### Solution

This package replaces Yoga's C++ implementation with:
- **Taffy v0.6.0**: Pure Rust flexbox layout engine
- **wasm-bindgen**: Minimal JavaScript interop layer
- **No C++ toolchain**: Only Rust required
- **Smaller footprint**: ~237KB total (230KB WASM + 7KB JS)

### Inspiration

This approach mirrors Socket's successful use of pure Rust for other WASM modules:
- **Acorn parser**: Pure Rust alternative to C++ Acorn
- **Custom Node.js builds**: Rust-based patches and optimizations

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Application Layer                        │
│                   (Ink, or other Yoga users)                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ Yoga API (compatible)
                      │
┌─────────────────────▼───────────────────────────────────────┐
│              JavaScript Adapter Layer                        │
│                    (src/index.mjs)                           │
│                                                               │
│  - Provides full Yoga API compatibility                      │
│  - Handles tree management (parent/child tracking)           │
│  - Implements measure functions (stubs)                      │
│  - Manages dirty tracking                                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ wasm-bindgen bindings
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    WASM Layer                                │
│              (build/wasm/yoga.wasm)                          │
│                                                               │
│  - Generated by wasm-bindgen from Rust                       │
│  - Exports core layout methods                               │
│  - ~230KB optimized with wasm-opt                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ Rust FFI
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   Rust Core Layer                            │
│                    (src/lib.rs)                              │
│                                                               │
│  - YogaNode wrapper around Taffy                             │
│  - Maps Yoga API to Taffy types                              │
│  - Handles enum conversions                                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ Taffy API
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                 Taffy Layout Engine                          │
│                    (taffy v0.6.0)                            │
│                                                               │
│  - Pure Rust flexbox implementation                          │
│  - W3C spec compliant                                        │
│  - Zero C++ dependencies                                     │
└─────────────────────────────────────────────────────────────┘
```

### Layer Responsibilities

1. **Application Layer**: Uses Yoga API without modification
2. **JavaScript Adapter**: Fills gaps in WASM bindings (tree management, callbacks)
3. **WASM Layer**: Fast compiled layout calculations
4. **Rust Core**: Translates Yoga API to Taffy types
5. **Taffy Engine**: Core flexbox algorithm implementation

## Installation

### Prerequisites

- **Rust 1.70+**: [Install Rust](https://www.rust-lang.org/tools/install)
- **wasm-opt**: [Install Binaryen](https://github.com/WebAssembly/binaryen)
- **Node.js 18+**: For building and testing

### Building from Source

```bash
# Install Rust target for WASM
rustup target add wasm32-unknown-unknown

# Build WASM module
node scripts/build.mjs

# Output will be in build/wasm/
# - yoga.wasm (~230KB)
# - yoga.js (~7KB)
```

### Build Options

```bash
# Force rebuild (ignore checkpoints)
node scripts/build.mjs --force

# The build process includes:
# 1. Rust compilation with release-wasm-fast profile
# 2. wasm-bindgen JavaScript binding generation
# 3. wasm-opt aggressive size optimization
# 4. WASM validation and verification
```

## Usage

### Basic Example

```javascript
import Yoga from '@socketsecurity/yoga-layout'

// Initialize WASM module
await Yoga.init()

// Create root node
const root = Yoga.Node.create()
root.setWidth(500)
root.setHeight(300)
root.setFlexDirection(Yoga.FlexDirection.Row)

// Create child nodes
const child1 = Yoga.Node.create()
child1.setFlexGrow(1)

const child2 = Yoga.Node.create()
child2.setFlexGrow(2)

root.insertChild(child1, 0)
root.insertChild(child2, 1)

// Calculate layout
root.calculateLayout(undefined, undefined, Yoga.DIRECTION_LTR)

// Read computed layout
console.log(child1.getComputedWidth())  // 166.67
console.log(child2.getComputedWidth())  // 333.33
```

### With Ink (React for CLIs)

```javascript
import Yoga from '@socketsecurity/yoga-layout'
import { render } from 'ink'

// Ink will automatically use Yoga for layout calculations
const { unmount } = render(<MyComponent />)
```

### Configuration

```javascript
// Create config (optional)
const config = Yoga.Config.create()
config.setUseWebDefaults(true)

// Create node with config
const node = Yoga.Node.create(config)
```

## API Compatibility

This implementation aims for Yoga API compatibility while leveraging Taffy's pure Rust implementation.

### ✅ Fully Supported

- **Layout calculation**: `calculateLayout()`, all layout getters
- **Flex properties**: flexDirection, flexGrow, flexShrink, flexBasis, flexWrap
- **Alignment**: justifyContent, alignItems, alignContent, alignSelf
- **Sizing**: width, height, minWidth, minHeight, maxWidth, maxHeight
- **Spacing**: margin, padding (all edges)
- **Tree management**: insertChild, removeChild, getChild, getChildCount

### ⚠️ Partial Support

- **insertChild index**: Taffy appends children; index parameter tracked but may not affect layout order
- **Config options**: Stored but don't affect Taffy calculations (useWebDefaults, pointScaleFactor)
- **Experimental features**: No-op (Taffy doesn't have feature flags)

### ❌ Not Supported

- **Measure functions**: Stored but not integrated with layout (Taffy limitation)
- **Border**: Taffy v0.6 doesn't support border in layout calculations
- **Position**: Absolute positioning not yet implemented
- **Aspect ratio**: Not implemented in current wrapper
- **Gap (grid-gap)**: Not implemented in current wrapper

See [API_COMPATIBILITY.md](./API_COMPATIBILITY.md) for detailed compatibility matrix.

## Build System

### Cargo Profile

We use a custom `release-wasm-fast` profile optimized for WASM size:

```toml
[profile.release-wasm-fast]
inherits = "release"
opt-level = "z"              # Optimize for size
lto = "thin"                 # Thin LTO for faster builds
codegen-units = 1            # Single unit for better optimization
strip = true                 # Strip symbols
panic = "abort"              # No unwinding (smaller code)
overflow-checks = false      # Remove overflow checks
debug-assertions = false     # Remove debug assertions
```

### RUSTFLAGS

We enable modern WASM features for better performance:

```bash
RUSTFLAGS="
  -C target-feature=+simd128                    # SIMD (20-30% perf boost)
  -C target-feature=+bulk-memory                # Bulk memory operations
  -C target-feature=+mutable-globals            # Mutable globals
  -C target-feature=+sign-ext                   # Sign extension
  -C target-feature=+nontrapping-fptoint        # Non-trapping float-to-int
  -C target-feature=+reference-types            # Reference types
  -C overflow-checks=off                        # Disable overflow checks
  -C debug-assertions=off                       # Disable debug assertions
"
```

**Note**: These flags require modern runtimes:
- Chrome 91+
- Firefox 89+
- Node.js 16+
- Safari 15+

### wasm-opt Flags

Aggressive optimization with wasm-opt (Binaryen):

```bash
wasm-opt -Oz \
  --enable-simd \
  --enable-bulk-memory \
  --enable-sign-ext \
  --enable-mutable-globals \
  --enable-nontrapping-float-to-int \
  --enable-reference-types \
  --low-memory-unused \
  --flatten \
  --rereloop \
  --vacuum \
  --dce \
  --remove-unused-names \
  --remove-unused-module-elements \
  --strip-debug \
  --strip-dwarf \
  --strip-producers \
  --strip-target-features
```

### Build Phases

1. **Rust compilation**: `cargo build --target wasm32-unknown-unknown --profile release-wasm-fast`
2. **JavaScript bindings**: `wasm-bindgen --target nodejs --out-dir build/pkg`
3. **Optimization**: `wasm-opt` with aggressive flags
4. **Verification**: Validate WASM magic number and size
5. **Export**: Copy to `build/wasm/` for distribution

## Testing

### Test Suite Approach

We test against Yoga's official test suite using a submodule approach:

```
.yoga-tests/                    # Git submodule (Yoga v3.1.0)
├── javascript/
│   └── tests/
│       ├── generated/          # Generated Yoga tests
│       │   ├── YGFlexTest.test.ts
│       │   ├── YGPaddingTest.test.ts
│       │   └── ...
│       └── YG*.test.ts         # Manual Yoga tests
```

This mirrors Socket's testing approach:
- **Acorn**: Tests against test262 suite via submodule
- **Babel transforms**: Tests against Babel's unit tests via submodule

### Running Tests

```bash
# Run Yoga compatibility tests
npm test

# Run specific test file
npm test -- YGFlexTest

# Update test snapshots
npm test -- --update-snapshots
```

See [TESTING.md](./TESTING.md) for detailed testing documentation.

## Performance

### Size Comparison

| Implementation | WASM Size | JS Size | Total |
|---------------|-----------|---------|-------|
| **Taffy (this)** | 230 KB | 7 KB | **237 KB** |
| Yoga (Emscripten) | 65 KB | 46 KB | 111 KB |

**Trade-offs**:
- Taffy is 2.1x larger but eliminates C++ toolchain
- Larger WASM, smaller JS glue code
- No platform-specific binaries needed
- Reproducible builds across environments

### Runtime Performance

Taffy is designed for high performance:
- Pure Rust (no FFI overhead)
- SIMD optimizations
- Modern WASM features (bulk-memory, reference-types)
- Efficient memory layout

Benchmarks TBD (see [TESTING.md](./TESTING.md)).

## Limitations

### Current Known Limitations

1. **insertChild index behavior**: Taffy's `add_child()` appends children. The index parameter is tracked in the adapter layer but may not affect layout order in all cases.

2. **Measure functions**: Yoga allows custom measure functions for leaf nodes. Taffy doesn't support this pattern directly. Measure functions are stored but not integrated with layout calculations.

3. **Config options**: Yoga's config options (pointScaleFactor, experimentalFeatures, errata) are stored for API compatibility but don't affect Taffy's layout calculations.

4. **Missing layout features** (can be added with additional Rust code):
   - Border (Taffy v0.6 limitation)
   - Absolute positioning
   - Aspect ratio
   - Gap (grid-gap)
   - Display: none

### Future Improvements

- [ ] Implement measure function integration (may require Taffy fork)
- [ ] Add missing layout features (border, position, aspect ratio)
- [ ] Performance benchmarking suite
- [ ] Full Yoga test suite compatibility
- [ ] TypeScript type definitions
- [ ] Browser WASM target (currently Node.js only)

## References

### Documentation

- **Yoga Layout**: https://yogalayout.dev/
  - Official documentation
  - API reference
  - Layout examples

- **Taffy**: https://github.com/DioxusLabs/taffy
  - Pure Rust flexbox engine
  - W3C spec compliant
  - Used by Dioxus UI framework

- **Ink**: https://github.com/vadimdemedes/ink
  - React for CLIs
  - Primary use case for this package

### Technical Resources

- **WASM Bindgen**: https://rustwasm.github.io/wasm-bindgen/
  - Rust ↔ JavaScript interop
  - WASM module generation

- **Binaryen**: https://github.com/WebAssembly/binaryen
  - wasm-opt optimizer
  - WASM validation tools

- **W3C Flexbox Spec**: https://www.w3.org/TR/css-flexbox-1/
  - Flexbox specification
  - Layout algorithm details

### Socket Implementation References

- **Acorn WASM**: `../ultrathink/acorn/`
  - Pure Rust parser
  - WASM build patterns
  - test262 test suite integration

- **Socket CLI Build Infrastructure**: `@socketsecurity/build-infra`
  - Shared build utilities
  - Checkpoint system
  - Environment setup

### Related Projects

- **yoga-wasm-web**: https://github.com/DioxusLabs/yoga-wasm-web
  - Alternative WASM Yoga binding
  - Uses original C++ Yoga with Emscripten

- **stretch**: https://github.com/vislyhq/stretch
  - Previous pure Rust flexbox engine
  - Deprecated in favor of Taffy

## Contributing

This package is part of Socket CLI. For contribution guidelines, see the main [Socket CLI repository](https://github.com/SocketDev/socket-cli).

### Development Workflow

```bash
# Install dependencies
pnpm install

# Build WASM
node scripts/build.mjs

# Run tests
npm test

# Force rebuild
node scripts/build.mjs --force
```

## License

MIT License - Copyright (c) Socket Security

This package uses:
- Taffy (MIT License)
- Yoga test suite (MIT License, Meta Platforms)
