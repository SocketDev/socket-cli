/**
 * Mock helpers for testing malware detection in Socket CLI.
 * Provides utilities to mock Socket API responses with malware alerts.
 */

import type {
  CompactSocketArtifact,
  CompactSocketArtifactAlert,
} from '../src/utils/alert/artifact.mts'

/**
 * Extended alert type with additional API fields not in base type.
 */
export type ExtendedAlert = CompactSocketArtifactAlert & {
  category?: string
  file?: string
}

/**
 * Extended CompactSocketArtifact type with additional API fields for testing.
 * The API returns score, size, and batchIndex data not included in the base type.
 */
export type CompactSocketArtifactWithScore = Omit<
  CompactSocketArtifact,
  'alerts'
> & {
  alerts: ExtendedAlert[]
  batchIndex?: number
  size?: number
  score?: {
    license: number
    maintenance: number
    overall: number
    quality: number
    supplyChain: number
    vulnerability: number
  }
}

/**
 * Creates a mocked malware package response for testing.
 * This simulates what the Socket API would return for a malicious package.
 */
export function createMalwarePackageResponse(): CompactSocketArtifactWithScore {
  return {
    id: '99999999999',
    size: 1024,
    type: 'npm',
    name: 'evil-test-package',
    version: '1.0.0',
    alerts: [
      {
        key: 'QTEST_MALWARE_KEY_12345678901234567890',
        type: 'malware',
        severity: 'critical',
        category: 'supplyChainRisk',
        file: 'evil-test-package-1.0.0/index.js',
        props: {
          id: 999999,
          note: 'This package contains malicious code that attempts to steal credentials and execute remote commands. DO NOT USE.',
        },
        action: 'error',
        fix: {
          type: 'remove',
          description:
            'Remove this package immediately and audit your system for compromise.',
        },
      },
      {
        key: 'QTEST_GPTMALWARE_KEY_98765432109876543210',
        type: 'gptMalware',
        severity: 'critical',
        category: 'supplyChainRisk',
        file: 'evil-test-package-1.0.0/index.js',
        props: {
          notes:
            'AI analysis detected highly suspicious patterns including credential harvesting, data exfiltration, and backdoor installation. This package poses an extreme security risk.',
          severity: 0.99,
          confidence: 0.98,
        },
        action: 'error',
      },
      {
        key: 'QTEST_NETWORK_ACCESS_KEY_11111111111111111111',
        type: 'networkAccess',
        severity: 'high',
        category: 'supplyChainRisk',
        file: 'evil-test-package-1.0.0/index.js',
        action: 'warn',
      },
    ],
    score: {
      license: 0,
      maintenance: 0,
      overall: 0.01,
      quality: 0,
      supplyChain: 0.01,
      vulnerability: 0,
    },
    batchIndex: 0,
    license: 'UNKNOWN',
    licenseDetails: [],
  }
}

/**
 * Creates a safe package response for testing (no malware).
 */
export function createSafePackageResponse(
  name: string,
  version: string,
): CompactSocketArtifactWithScore {
  return {
    id: '12345678',
    size: 512,
    type: 'npm',
    name,
    version,
    alerts: [],
    score: {
      license: 1,
      maintenance: 1,
      overall: 1,
      quality: 1,
      supplyChain: 1,
      vulnerability: 1,
    },
    batchIndex: 0,
    license: 'MIT',
    licenseDetails: [],
  }
}
